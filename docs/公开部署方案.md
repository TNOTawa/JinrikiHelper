# 人力V助手 在线部署方案

## 一、平台对比与选择

| 平台 | 免费配额 | GPU | 存储 | 国内访问 | 推荐度 |
|------|----------|-----|------|----------|--------|
| Hugging Face Spaces | 2vCPU/16GB | 付费 | 50GB | 较慢 | ⭐⭐⭐ |
| 魔塔社区 (ModelScope) | 2vCPU/16GB | 免费T4 | 50GB | 快 | ⭐⭐⭐⭐⭐ |
| 阿里云函数计算 | 按量付费 | 可选 | - | 快 | ⭐⭐ |

**推荐：魔塔社区** - 国内访问快、免费 GPU、对中文项目友好

---

## 二、核心问题与解决方案

### 问题1：MFA 引擎不兼容

当前 MFA 使用 Windows 外挂模式 (`tools/mfa_engine/python.exe`)，云平台为 Linux。

**解决方案：使用 conda 安装 MFA**

```dockerfile
# 在 Linux 环境安装 MFA
RUN conda install -c conda-forge montreal-forced-aligner -y
```

需要修改 `src/mfa_runner.py` 支持 Linux 原生调用。

### 问题2：模型文件体积大

| 模型 | 大小 | 处理方式 |
|------|------|----------|
| Whisper small | ~500MB | 首次运行自动下载 |
| Whisper medium | ~1.5GB | 首次运行自动下载 |
| Silero VAD | ~2MB | 打包到仓库 |
| MFA 声学模型 | ~100MB | 打包或首次下载 |

### 问题3：用户数据存储

云平台重启后数据丢失，需要：
- 处理完成后提供下载链接
- 或集成云存储 (OSS/S3)

---

## 三、代码改造清单

### 3.1 MFA 运行器改造

创建 `src/mfa_runner_linux.py` 或修改现有文件支持双平台：

```python
import platform
import subprocess

def get_mfa_command():
    """根据平台返回 MFA 命令"""
    if platform.system() == "Windows":
        # Windows: 使用外挂 Python
        return [str(MFA_PYTHON), "-m", "montreal_forced_aligner"]
    else:
        # Linux: 使用系统安装的 mfa
        return ["mfa"]

def run_mfa_alignment(...):
    cmd = get_mfa_command() + ["align", ...]
    # ...
```

### 3.2 路径处理改造

```python
import tempfile

# 云环境使用临时目录
if os.environ.get("SPACE_ID"):  # HF Spaces
    BANK_DIR = tempfile.mkdtemp()
    EXPORT_DIR = tempfile.mkdtemp()
```

### 3.3 GUI 改造

添加下载按钮，让用户下载处理结果：

```python
# 在导出完成后提供下载
output_zip = gr.File(label="下载结果")
```

---

## 四、Hugging Face Spaces 部署

### 4.1 目录结构

```
jinriki-helper/
├── app.py                   # 入口 (重命名自 main.py)
├── requirements.txt
├── packages.txt             # 系统依赖
├── README.md
├── src/
├── models/
│   └── silero_vad/          # 预置小模型
└── ...
```

### 4.2 创建 packages.txt

```
ffmpeg
libsndfile1
```

### 4.3 创建 app.py

```python
# HF Spaces 入口
import os
os.environ["GRADIO_SERVER_NAME"] = "0.0.0.0"

from src.gui import create_ui

app = create_ui()
app.launch()
```

### 4.4 修改 requirements.txt

移除 Windows 专用依赖，添加：
```
montreal-forced-aligner
```

### 4.5 部署步骤

1. 创建 HF 账号并新建 Space (选择 Gradio SDK)
2. 上传代码或连接 GitHub 仓库
3. 等待构建完成

---

## 五、魔塔社区部署 (推荐)

### 5.1 目录结构

```
jinriki-helper/
├── app.py
├── requirements.txt
├── README.md
├── src/
└── ...
```

### 5.2 创建 app.py

```python
# 魔塔社区入口
import os
import subprocess

# 安装 MFA (首次运行)
def setup_mfa():
    try:
        subprocess.run(["mfa", "version"], check=True, capture_output=True)
    except:
        print("正在安装 MFA...")
        subprocess.run([
            "pip", "install", "montreal-forced-aligner"
        ], check=True)
        # 下载模型
        subprocess.run(["mfa", "model", "download", "acoustic", "mandarin_mfa"])
        subprocess.run(["mfa", "model", "download", "dictionary", "mandarin_china_mfa"])

setup_mfa()

from src.gui import create_ui
app = create_ui()
app.launch()
```

### 5.3 部署步骤

1. 注册魔塔社区账号: https://modelscope.cn
2. 创建新的创空间 (选择 Gradio)
3. 上传代码或关联 GitHub
4. 配置环境 (选择 GPU 实例可加速 Whisper)

---

## 六、需要修改的文件

### 6.1 src/mfa_runner.py

```python
# 添加跨平台支持
import platform
import shutil

def check_mfa_available() -> bool:
    """检查 MFA 是否可用"""
    if platform.system() == "Windows":
        return MFA_PYTHON.exists()
    else:
        # Linux: 检查系统命令
        return shutil.which("mfa") is not None

def _get_mfa_cmd() -> list:
    """获取 MFA 命令前缀"""
    if platform.system() == "Windows":
        return [str(MFA_PYTHON), "-m", "montreal_forced_aligner"]
    return ["mfa"]
```

### 6.2 src/gui.py

```python
# 添加结果下载功能
import zipfile
import tempfile

def create_download_zip(source_dir: str) -> str:
    """打包目录为 zip 供下载"""
    zip_path = tempfile.mktemp(suffix=".zip")
    with zipfile.ZipFile(zip_path, 'w') as zf:
        for root, dirs, files in os.walk(source_dir):
            for file in files:
                file_path = os.path.join(root, file)
                arcname = os.path.relpath(file_path, source_dir)
                zf.write(file_path, arcname)
    return zip_path
```

### 6.3 requirements.txt (云端版)

```
gradio==6.2.0
transformers>=4.25.0
torch
torchaudio
accelerate
silero-vad>=5.1
onnxruntime
textgrid
audiofile
tqdm
pypinyin
pykakasi
# Linux 环境直接 pip 安装 MFA
montreal-forced-aligner
```

---

## 七、功能限制说明

在线版相比本地版的限制：

| 功能 | 本地版 | 在线版 |
|------|--------|--------|
| 处理大文件 | ✅ 无限制 | ⚠️ 受内存限制 |
| 数据持久化 | ✅ 本地保存 | ❌ 需下载 |
| GPU 加速 | ✅ 本地显卡 | ⚠️ 取决于平台 |
| 批量处理 | ✅ 支持 | ⚠️ 建议限制数量 |

建议在 UI 中添加提示：
> 在线版适合试用和小规模处理，大规模制作建议下载本地版

---

## 八、执行步骤

### 第一步：改造 MFA 运行器
修改 `src/mfa_runner.py` 支持 Linux

### 第二步：创建云端入口
创建 `app.py`

### 第三步：添加下载功能
修改 `src/gui.py` 添加结果打包下载

### 第四步：部署测试
先在魔塔社区测试，成功后同步到 HF Spaces

---

需要我帮你执行代码改造吗？
